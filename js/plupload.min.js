(function(O,U){var z=function(){var D={};U.apply(D,arguments);return D.plupload};"function"===typeof define&&define.amd?define("plupload",["./moxie"],z):"object"===typeof module&&module.exports?module.exports=z(require("./moxie")):O.plupload=z(O.moxie)})(this||window,function(O){(function(U,z,D){function W(d){function e(A,G,P){var Q={chunks:"slice_blob",jpgresize:"send_binary_string",pngresize:"send_binary_string",progress:"report_upload_progress",multi_selection:"select_multiple",dragdrop:"drag_and_drop",
drop_element:"drag_and_drop",headers:"send_custom_headers",urlstream_upload:"send_binary_string",canSendBinary:"send_binary",triggerDialog:"summon_file_dialog"};Q[A]?u[Q[A]]=G:P||(u[A]=G)}var f=d.required_features,u={};"string"===typeof f?b.each(f.split(/\s*,\s*/),function(A){e(A,!0)}):"object"===typeof f?b.each(f,function(A,G){e(G,A)}):!0===f&&(d.chunk_size&&0<d.chunk_size&&(u.slice_blob=!0),b.isEmptyObj(d.resize)&&!1!==d.multipart||(u.send_binary_string=!0),d.http_method&&(u.use_http_method=d.http_method),
b.each(d,function(A,G){e(G,!!A,!0)}));return u}var K=window.setTimeout,V={},v=z.core.utils,J=z.runtime.Runtime,b={VERSION:"2.3.6",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,FILE_DUPLICATE_ERROR:-602,IMAGE_FORMAT_ERROR:-700,MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,moxie:z,mimeTypes:v.Mime.mimes,ua:v.Env,typeOf:v.Basic.typeOf,extend:v.Basic.extend,guid:v.Basic.guid,
getAll:function(d){var e=[],f;"array"!==b.typeOf(d)&&(d=[d]);for(var u=d.length;u--;)(f=b.get(d[u]))&&e.push(f);return e.length?e:null},get:v.Dom.get,each:v.Basic.each,getPos:v.Dom.getPos,getSize:v.Dom.getSize,xmlEncode:function(d){var e={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"},f=/[<>&"']/g;return d?(""+d).replace(f,function(u){return e[u]?"&"+e[u]+";":u}):d},toArray:v.Basic.toArray,inArray:v.Basic.inArray,inSeries:v.Basic.inSeries,addI18n:z.core.I18n.addI18n,translate:z.core.I18n.translate,
sprintf:v.Basic.sprintf,isEmptyObj:v.Basic.isEmptyObj,hasClass:v.Dom.hasClass,addClass:v.Dom.addClass,removeClass:v.Dom.removeClass,getStyle:v.Dom.getStyle,addEvent:v.Events.addEvent,removeEvent:v.Events.removeEvent,removeAllEvents:v.Events.removeAllEvents,cleanName:function(d){var e;var f=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,
"U",/[\371-\374]/g,"u"];for(e=0;e<f.length;e+=2)d=d.replace(f[e],f[e+1]);d=d.replace(/\s+/g,"_");return d=d.replace(/[^a-z0-9_\-\.]+/gi,"")},buildUrl:function(d,e){var f="";b.each(e,function(u,A){f+=(f?"&":"")+encodeURIComponent(A)+"="+encodeURIComponent(u)});f&&(d+=(0<d.indexOf("?")?"&":"?")+f);return d},formatSize:function(d){function e(u,A){return Math.round(u*Math.pow(10,A))/Math.pow(10,A)}if(d===D||/\D/.test(d))return b.translate("N/A");var f=Math.pow(1024,4);return d>f?e(d/f,1)+" "+b.translate("tb"):
d>(f/=1024)?e(d/f,1)+" "+b.translate("gb"):d>(f/=1024)?e(d/f,1)+" "+b.translate("mb"):1024<d?Math.round(d/1024)+" "+b.translate("kb"):d+" "+b.translate("b")},parseSize:v.Basic.parseSizeStr,predictRuntime:function(d,e){var f=new b.Uploader(d);d=J.thatCan(f.getOption().required_features,e||d.runtimes);f.destroy();return d},addFileFilter:function(d,e){V[d]=e}};b.addFileFilter("mime_types",function(d,e,f){d.length&&!d.regexp.test(e.name)?(this.trigger("Error",{code:b.FILE_EXTENSION_ERROR,message:b.translate("File extension error."),
file:e}),f(!1)):f(!0)});b.addFileFilter("max_file_size",function(d,e,f){d=b.parseSize(d);void 0!==e.size&&d&&e.size>d?(this.trigger("Error",{code:b.FILE_SIZE_ERROR,message:b.translate("File size error."),file:e}),f(!1)):f(!0)});b.addFileFilter("prevent_duplicates",function(d,e,f){if(d)for(d=this.files.length;d--;)if(e.name===this.files[d].name&&e.size===this.files[d].size){this.trigger("Error",{code:b.FILE_DUPLICATE_ERROR,message:b.translate("Duplicate file error."),file:e});f(!1);return}f(!0)});
b.addFileFilter("prevent_empty",function(d,e,f){d&&!e.size&&e.size!==D?(this.trigger("Error",{code:b.FILE_SIZE_ERROR,message:b.translate("File size error."),file:e}),f(!1)):f(!0)});b.Uploader=function(d){function e(){var a=0,c;if(this.state==b.STARTED){for(c=0;c<x.length;c++)if(g||x[c].status!=b.QUEUED)a++;else{var g=x[c];this.trigger("BeforeUpload",g)&&(g.status=b.UPLOADING,this.trigger("UploadFile",g))}a==x.length&&(this.state!==b.STOPPED&&(this.state=b.STOPPED,this.trigger("StateChanged")),this.trigger("UploadComplete",
x))}}function f(a){a.percent=0<a.size?Math.ceil(a.loaded/a.size*100):100;u()}function u(){var a,c=0;y.reset();for(a=0;a<x.length;a++){var g=x[a];if(g.size!==D){y.size+=g.origSize;var h=g.loaded*g.origSize/g.size;if(!g.completeTimestamp||g.completeTimestamp>R)c+=h;y.loaded+=h}else y.size=D;g.status==b.DONE?y.uploaded++:g.status==b.FAILED?y.failed++:y.queued++}y.size===D?y.percent=0<x.length?Math.ceil(y.uploaded/x.length*100):0:(y.bytesPerSec=Math.ceil(c/((+new Date-R||1)/1E3)),y.percent=0<y.size?Math.ceil(y.loaded/
y.size*100):0)}function A(){var a=F[0]||L[0];return a?a.getRuntime().uid:!1}function G(){this.bind("FilesAdded FilesRemoved",function(a){a.trigger("QueueChanged");a.refresh()});this.bind("CancelUpload",Z);this.bind("BeforeUpload",aa);this.bind("UploadFile",ba);this.bind("UploadProgress",ca);this.bind("StateChanged",da);this.bind("QueueChanged",u);this.bind("Error",ea);this.bind("FileUploaded",fa);this.bind("Destroy",ha)}function P(a,c){var g=this,h=0,p=[],w={runtime_order:a.runtimes,required_caps:a.required_features,
preferred_caps:S,swf_url:a.flash_swf_url,xap_url:a.silverlight_xap_url};b.each(a.runtimes.split(/\s*,\s*/),function(m){a[m]&&(w[m]=a[m])});a.browse_button&&b.each(a.browse_button,function(m){p.push(function(k){var l=new z.file.FileInput(b.extend({},w,{accept:a.filters.mime_types,name:a.file_data_name,multiple:a.multi_selection,container:a.container,browse_button:m}));l.onready=function(){var n=J.getInfo(this.ruid);b.extend(g.features,{chunks:n.can("slice_blob"),multipart:n.can("send_multipart"),multi_selection:n.can("select_multiple")});
h++;F.push(this);k()};l.onchange=function(){g.addFile(this.files)};l.bind("mouseenter mouseleave mousedown mouseup",function(n){M||(a.browse_button_hover&&("mouseenter"===n.type?b.addClass(m,a.browse_button_hover):"mouseleave"===n.type&&b.removeClass(m,a.browse_button_hover)),a.browse_button_active&&("mousedown"===n.type?b.addClass(m,a.browse_button_active):"mouseup"===n.type&&b.removeClass(m,a.browse_button_active)))});l.bind("mousedown",function(){g.trigger("Browse")});l.bind("error runtimeerror",
function(){l=null;k()});l.init()})});a.drop_element&&b.each(a.drop_element,function(m){p.push(function(k){var l=new z.file.FileDrop(b.extend({},w,{drop_zone:m}));l.onready=function(){var n=J.getInfo(this.ruid);b.extend(g.features,{chunks:n.can("slice_blob"),multipart:n.can("send_multipart"),dragdrop:n.can("drag_and_drop")});h++;L.push(this);k()};l.ondrop=function(){g.addFile(this.files)};l.bind("error runtimeerror",function(){l=null;k()});l.init()})});b.inSeries(p,function(){"function"===typeof c&&
c(h)})}function Q(a,c,g,h){var p=new z.image.Image;try{p.onload=function(){c.width>this.width&&c.height>this.height&&c.quality===D&&c.preserve_headers&&!c.crop?(this.destroy(),h(a)):p.downsize(c.width,c.height,c.crop,c.preserve_headers)},p.onresize=function(){var w=this.getAsBlob(a.type,c.quality);this.destroy();h(w)},p.bind("error runtimeerror",function(){this.destroy();h(a)}),p.load(a,g)}catch(w){h(a)}}function X(a,c,g){function h(m,k,l){var n=q[m];switch(m){case "max_file_size":"max_file_size"===
m&&(q.max_file_size=q.filters.max_file_size=k);break;case "chunk_size":if(k=b.parseSize(k))q[m]=k,q.send_file_name=!0;break;case "multipart":q[m]=k;k||(q.send_file_name=!0);break;case "http_method":q[m]="PUT"===k.toUpperCase()?"PUT":"POST";break;case "unique_names":if(q[m]=k)q.send_file_name=!0;break;case "filters":"array"===b.typeOf(k)&&(k={mime_types:k});l?b.extend(q.filters,k):q.filters=k;k.mime_types&&("string"===b.typeOf(k.mime_types)&&(k.mime_types=z.core.utils.Mime.mimes2extList(k.mime_types)),
k.mime_types.regexp=function(E){var t=[];b.each(E,function(B){b.each(B.extensions.split(/,/),function(C){/^\s*\*\s*$/.test(C)?t.push("\\.*"):t.push("\\."+C.replace(new RegExp("["+"/^$.*+?|()[]{}\\".replace(/./g,"\\$&")+"]","g"),"\\$&"))})});return new RegExp("("+t.join("|")+")$","i")}(k.mime_types),q.filters.mime_types=k.mime_types);break;case "resize":q.resize=k?b.extend({preserve_headers:!0,crop:!1},k):!1;break;case "prevent_duplicates":q.prevent_duplicates=q.filters.prevent_duplicates=!!k;break;
case "container":case "browse_button":case "drop_element":k="container"===m?b.get(k):b.getAll(k);case "runtimes":case "multi_selection":case "flash_swf_url":case "silverlight_xap_url":q[m]=k;l||(w=!0);break;default:q[m]=k}l||p.trigger("OptionChanged",m,k,n)}var p=this,w=!1;"object"===typeof a?b.each(a,function(m,k){h(k,m,g)}):h(a,c,g);g?(q.required_features=W(b.extend({},q)),S=W(b.extend({},q,{required_features:!0}))):w&&(p.trigger("Destroy"),P.call(p,q,function(m){m?(p.runtime=J.getInfo(A()).type,
p.trigger("Init",{runtime:p.runtime}),p.trigger("PostInit")):p.trigger("Error",{code:b.INIT_ERROR,message:b.translate("Init error.")})}))}function aa(a,c){if(a.settings.unique_names){a=c.name.match(/\.([^.]+)$/);var g="part";a&&(g=a[1]);c.target_name=c.id+"."+g}}function ba(a,c){function g(){0<k--?K(h,1E3):(c.loaded=n,a.trigger("Error",{code:b.HTTP_ERROR,message:b.translate("HTTP Error."),file:c,response:r.responseText,status:r.status,responseHeaders:r.getAllResponseHeaders()}))}function h(){var B=
{};if(c.status===b.UPLOADING&&a.state!==b.STOPPED){a.settings.send_file_name&&(B.name=c.target_name||c.name);if(m&&l.chunks&&t.size>m){var C=Math.min(m,t.size-n);var H=t.slice(n,n+C)}else C=t.size,H=t;m&&l.chunks&&(a.settings.send_chunk_number?(B.chunk=Math.ceil(n/m),B.chunks=Math.ceil(t.size/m)):(B.offset=n,B.total=t.size));a.trigger("BeforeChunkUpload",c,B,H,n)&&p(B,H,C)}}function p(B,C,H){r=new z.xhr.XMLHttpRequest;r.upload&&(r.upload.onprogress=function(I){c.loaded=Math.min(c.size,n+I.loaded);
a.trigger("UploadProgress",c)});r.onload=function(){200>r.status||400<=r.status?g():(k=a.settings.max_retries,H<t.size?(C.destroy(),n+=H,c.loaded=Math.min(n,t.size),a.trigger("ChunkUploaded",c,{offset:c.loaded,total:t.size,response:r.responseText,status:r.status,responseHeaders:r.getAllResponseHeaders()}),"Android Browser"===b.ua.browser&&a.trigger("UploadProgress",c)):c.loaded=c.size,C=T=null,!n||n>=t.size?(c.size!=c.origSize&&(t.destroy(),t=null),a.trigger("UploadProgress",c),c.status=b.DONE,c.completeTimestamp=
+new Date,a.trigger("FileUploaded",c,{response:r.responseText,status:r.status,responseHeaders:r.getAllResponseHeaders()})):K(h,1))};r.onerror=function(){g()};r.onloadend=function(){this.destroy()};if(a.settings.multipart&&l.multipart){r.open(a.settings.http_method,w,!0);b.each(a.settings.headers,function(I,N){r.setRequestHeader(N,I)});var T=new z.xhr.FormData;b.each(b.extend(B,a.settings.multipart_params),function(I,N){T.append(N,I)});T.append(a.settings.file_data_name,C);r.send(T,E)}else w=b.buildUrl(a.settings.url,
b.extend(B,a.settings.multipart_params)),r.open(a.settings.http_method,w,!0),b.each(a.settings.headers,function(I,N){r.setRequestHeader(N,I)}),r.hasRequestHeader("Content-Type")||r.setRequestHeader("Content-Type","application/octet-stream"),r.send(C,E)}var w=a.settings.url,m=a.settings.chunk_size,k=a.settings.max_retries,l=a.features,n=0,E={runtime_order:a.settings.runtimes,required_caps:a.settings.required_features,preferred_caps:S,swf_url:a.settings.flash_swf_url,xap_url:a.settings.silverlight_xap_url};
c.loaded&&(n=c.loaded=m?m*Math.floor(c.loaded/m):0);var t=c.getSource();b.isEmptyObj(a.settings.resize)||-1===b.inArray(t.type,["image/jpeg","image/png"])?h():Q(t,a.settings.resize,E,function(B){t=B;c.size=B.size;h()})}function ca(a,c){f(c)}function da(a){if(a.state==b.STARTED)R=+new Date;else if(a.state==b.STOPPED)for(var c=a.files.length-1;0<=c;c--)a.files[c].status==b.UPLOADING&&(a.files[c].status=b.QUEUED,u())}function Z(){r&&r.abort()}function fa(a){u();K(function(){e.call(a)},1)}function ea(a,
c){c.code===b.INIT_ERROR?a.destroy():c.code===b.HTTP_ERROR&&(c.file.status=b.FAILED,c.file.completeTimestamp=+new Date,f(c.file),a.state==b.STARTED&&(a.trigger("CancelUpload"),K(function(){e.call(a)},1)))}function ha(a){a.stop();b.each(x,function(c){c.destroy()});x=[];F.length&&(b.each(F,function(c){c.destroy()}),F=[]);L.length&&(b.each(L,function(c){c.destroy()}),L=[]);S={};M=!1;R=r=null;y.reset()}var Y=b.guid(),x=[],S={},F=[],L=[],R,M=!1,r;var q={chunk_size:0,file_data_name:"file",filters:{mime_types:[],
max_file_size:0,prevent_duplicates:!1,prevent_empty:!0},flash_swf_url:"js/Moxie.swf",http_method:"POST",max_retries:0,multipart:!0,multi_selection:!0,resize:!1,runtimes:J.order,send_file_name:!0,send_chunk_number:!0,silverlight_xap_url:"js/Moxie.xap"};X.call(this,d,null,!0);var y=new b.QueueProgress;b.extend(this,{id:Y,uid:Y,state:b.STOPPED,features:{},runtime:null,files:x,settings:q,total:y,init:function(){var a=this,c;var g=a.getOption("preinit");"function"==typeof g?g(a):b.each(g,function(h,p){a.bind(p,
h)});G.call(a);b.each(["container","browse_button","drop_element"],function(h){if(null===a.getOption(h))return c={code:b.INIT_ERROR,message:b.sprintf(b.translate("%s specified, but cannot be found."),h)},!1});if(c)return a.trigger("Error",c);if(!q.browse_button&&!q.drop_element)return a.trigger("Error",{code:b.INIT_ERROR,message:b.translate("You must specify either browse_button or drop_element.")});P.call(a,q,function(h){var p=a.getOption("init");"function"==typeof p?p(a):b.each(p,function(w,m){a.bind(m,
w)});h?(a.runtime=J.getInfo(A()).type,a.trigger("Init",{runtime:a.runtime}),a.trigger("PostInit")):a.trigger("Error",{code:b.INIT_ERROR,message:b.translate("Init error.")})})},setOption:function(a,c){X.call(this,a,c,!this.runtime)},getOption:function(a){return a?q[a]:q},refresh:function(){F.length&&b.each(F,function(a){a.trigger("Refresh")});this.trigger("Refresh")},start:function(){this.state!=b.STARTED&&(this.state=b.STARTED,this.trigger("StateChanged"),e.call(this))},stop:function(){this.state!=
b.STOPPED&&(this.state=b.STOPPED,this.trigger("StateChanged"),this.trigger("CancelUpload"))},disableBrowse:function(a){M=a!==D?a:!0;F.length&&b.each(F,function(c){c.disable(M)});this.trigger("DisableBrowse",M)},getFile:function(a){var c;for(c=x.length-1;0<=c;c--)if(x[c].id===a)return x[c]},addFile:function(a,c){function g(l,n){var E=[];b.each(p.settings.filters,function(t,B){V[B]&&E.push(function(C){V[B].call(p,t,l,function(H){C(!H)})})});b.inSeries(E,n)}function h(l){var n=b.typeOf(l);if(l instanceof
z.file.File){if(!l.ruid&&!l.isDetached()){if(!k)return!1;l.ruid=k;l.connectRuntime(k)}h(new b.File(l))}else l instanceof z.file.Blob?(h(l.getSource()),l.destroy()):l instanceof b.File?(c&&(l.name=c),w.push(function(E){g(l,function(t){t||(x.push(l),m.push(l),p.trigger("FileFiltered",l));K(E,1)})})):-1!==b.inArray(n,["file","blob"])?h(new z.file.File(null,l)):"node"===n&&"filelist"===b.typeOf(l.files)?b.each(l.files,h):"array"===n&&(c=null,b.each(l,h))}var p=this,w=[],m=[];var k=A();h(a);w.length&&
b.inSeries(w,function(){m.length&&p.trigger("FilesAdded",m)})},removeFile:function(a){a="string"===typeof a?a:a.id;for(var c=x.length-1;0<=c;c--)if(x[c].id===a)return this.splice(c,1)[0]},splice:function(a,c){a=x.splice(a===D?0:a,c===D?x.length:c);var g=!1;this.state==b.STARTED&&(b.each(a,function(h){if(h.status===b.UPLOADING)return g=!0,!1}),g&&this.stop());this.trigger("FilesRemoved",a);b.each(a,function(h){h.destroy()});g&&this.start();return a},dispatchEvent:function(a){var c;a=a.toLowerCase();
if(c=this.hasEventListener(a)){c.sort(function(p,w){return w.priority-p.priority});var g=[].slice.call(arguments);g.shift();g.unshift(this);for(var h=0;h<c.length;h++)if(!1===c[h].fn.apply(c[h].scope,g))return!1}return!0},bind:function(a,c,g,h){b.Uploader.prototype.bind.call(this,a,c,h,g)},destroy:function(){this.trigger("Destroy");q=y=null;this.unbindAll()}})};b.Uploader.prototype=z.core.EventTarget.instance;b.File=function(){var d={};return function(e){b.extend(this,{id:b.guid(),name:e.name||e.fileName,
type:e.type||"",relativePath:e.relativePath||"",size:e.fileSize||e.size,origSize:e.fileSize||e.size,loaded:0,percent:0,status:b.QUEUED,lastModifiedDate:e.lastModifiedDate||(new Date).toLocaleString(),completeTimestamp:0,getNative:function(){var f=this.getSource().getSource();return-1!==b.inArray(b.typeOf(f),["blob","file"])?f:null},getSource:function(){return d[this.id]?d[this.id]:null},destroy:function(){var f=this.getSource();f&&(f.destroy(),delete d[this.id])}});d[this.id]=e}}();b.QueueProgress=
function(){var d=this;d.size=0;d.loaded=0;d.uploaded=0;d.failed=0;d.queued=0;d.percent=0;d.bytesPerSec=0;d.reset=function(){d.size=d.loaded=d.uploaded=d.failed=d.queued=d.percent=d.bytesPerSec=0}};U.plupload=b})(this,O)});
