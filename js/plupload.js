(function(c,a){var b=function(){var d={};a.apply(d,arguments);return d.plupload};if(typeof define==="function"&&define.amd){define("plupload",["./moxie"],b)}else{if(typeof module==="object"&&module.exports){module.exports=b(require("./moxie"))}else{c.plupload=b(c.moxie)}}}(this||window,function(a){(function(f,c,e){var g=window.setTimeout;var j={};var k=c.core.utils;var b=c.runtime.Runtime;function i(m){var l=m.required_features,n={};function o(q,r,p){var s={chunks:"slice_blob",jpgresize:"send_binary_string",pngresize:"send_binary_string",progress:"report_upload_progress",multi_selection:"select_multiple",dragdrop:"drag_and_drop",drop_element:"drag_and_drop",headers:"send_custom_headers",urlstream_upload:"send_binary_string",canSendBinary:"send_binary",triggerDialog:"summon_file_dialog"};if(s[q]){n[s[q]]=r}else{if(!p){n[q]=r}}}if(typeof(l)==="string"){h.each(l.split(/\s*,\s*/),function(p){o(p,true)})}else{if(typeof(l)==="object"){h.each(l,function(q,p){o(p,q)})}else{if(l===true){if(m.chunk_size&&m.chunk_size>0){n.slice_blob=true}if(!h.isEmptyObj(m.resize)||m.multipart===false){n.send_binary_string=true}if(m.http_method){n.use_http_method=m.http_method}h.each(m,function(q,p){o(p,!!q,true)})}}}return n}var h={VERSION:"2.3.6",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,FILE_DUPLICATE_ERROR:-602,IMAGE_FORMAT_ERROR:-700,MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,moxie:c,mimeTypes:k.Mime.mimes,ua:k.Env,typeOf:k.Basic.typeOf,extend:k.Basic.extend,guid:k.Basic.guid,getAll:function d(o){var m=[],n;if(h.typeOf(o)!=="array"){o=[o]}var l=o.length;while(l--){n=h.get(o[l]);if(n){m.push(n)}}return m.length?m:null},get:k.Dom.get,each:k.Basic.each,getPos:k.Dom.getPos,getSize:k.Dom.getSize,xmlEncode:function(m){var n={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"},l=/[<>&\"\']/g;return m?(""+m).replace(l,function(o){return n[o]?"&"+n[o]+";":o}):m},toArray:k.Basic.toArray,inArray:k.Basic.inArray,inSeries:k.Basic.inSeries,addI18n:c.core.I18n.addI18n,translate:c.core.I18n.translate,sprintf:k.Basic.sprintf,isEmptyObj:k.Basic.isEmptyObj,hasClass:k.Dom.hasClass,addClass:k.Dom.addClass,removeClass:k.Dom.removeClass,getStyle:k.Dom.getStyle,addEvent:k.Events.addEvent,removeEvent:k.Events.removeEvent,removeAllEvents:k.Events.removeAllEvents,cleanName:function(l){var m,n;n=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"];for(m=0;m<n.length;m+=2){l=l.replace(n[m],n[m+1])}l=l.replace(/\s+/g,"_");l=l.replace(/[^a-z0-9_\-\.]+/gi,"");return l},buildUrl:function(m,l){var n="";h.each(l,function(p,o){n+=(n?"&":"")+encodeURIComponent(o)+"="+encodeURIComponent(p)});if(n){m+=(m.indexOf("?")>0?"&":"?")+n}return m},formatSize:function(m){if(m===e||/\D/.test(m)){return h.translate("N/A")}function l(p,o){return Math.round(p*Math.pow(10,o))/Math.pow(10,o)}var n=Math.pow(1024,4);if(m>n){return l(m/n,1)+" "+h.translate("tb")}if(m>(n/=1024)){return l(m/n,1)+" "+h.translate("gb")}if(m>(n/=1024)){return l(m/n,1)+" "+h.translate("mb")}if(m>1024){return Math.round(m/1024)+" "+h.translate("kb")}return m+" "+h.translate("b")},parseSize:k.Basic.parseSizeStr,predictRuntime:function(n,m){var l,o;l=new h.Uploader(n);o=b.thatCan(l.getOption().required_features,m||n.runtimes);l.destroy();return o},addFileFilter:function(m,l){j[m]=l}};h.addFileFilter("mime_types",function(n,m,l){if(n.length&&!n.regexp.test(m.name)){this.trigger("Error",{code:h.FILE_EXTENSION_ERROR,message:h.translate("File extension error."),file:m});l(false)}else{l(true)}});h.addFileFilter("max_file_size",function(o,m,l){var n;o=h.parseSize(o);if(m.size!==n&&o&&m.size>o){this.trigger("Error",{code:h.FILE_SIZE_ERROR,message:h.translate("File size error."),file:m});l(false)}else{l(true)}});h.addFileFilter("prevent_duplicates",function(o,m,l){if(o){var n=this.files.length;while(n--){if(m.name===this.files[n].name&&m.size===this.files[n].size){this.trigger("Error",{code:h.FILE_DUPLICATE_ERROR,message:h.translate("Duplicate file error."),file:m});l(false);return}}}l(true)});h.addFileFilter("prevent_empty",function(n,m,l){if(n&&!m.size&&m.size!==e){this.trigger("Error",{code:h.FILE_SIZE_ERROR,message:h.translate("File size error."),file:m});l(false)}else{l(true)}});h.Uploader=function(o){var w=h.guid(),I,s=[],A={},H=[],z=[],F,L,q=false,y;function K(){var N,O=0,M;if(this.state==h.STARTED){for(M=0;M<s.length;M++){if(!N&&s[M].status==h.QUEUED){N=s[M];if(this.trigger("BeforeUpload",N)){N.status=h.UPLOADING;this.trigger("UploadFile",N)}}else{O++}}if(O==s.length){if(this.state!==h.STOPPED){this.state=h.STOPPED;this.trigger("StateChanged")}this.trigger("UploadComplete",s)}}}function n(M){M.percent=M.size>0?Math.ceil(M.loaded/M.size*100):100;m()}function m(){var O,N;var M;var P=0;L.reset();for(O=0;O<s.length;O++){N=s[O];if(N.size!==e){L.size+=N.origSize;M=N.loaded*N.origSize/N.size;if(!N.completeTimestamp||N.completeTimestamp>F){P+=M}L.loaded+=M}else{L.size=e}if(N.status==h.DONE){L.uploaded++}else{if(N.status==h.FAILED){L.failed++}else{L.queued++}}}if(L.size===e){L.percent=s.length>0?Math.ceil(L.uploaded/s.length*100):0}else{L.bytesPerSec=Math.ceil(P/((+new Date()-F||1)/1000));L.percent=L.size>0?Math.ceil(L.loaded/L.size*100):0}}function J(){var M=H[0]||z[0];if(M){return M.getRuntime().uid}return false}function B(){this.bind("FilesAdded FilesRemoved",function(M){M.trigger("QueueChanged");M.refresh()});this.bind("CancelUpload",l);this.bind("BeforeUpload",E);this.bind("UploadFile",G);this.bind("UploadProgress",x);this.bind("StateChanged",D);this.bind("QueueChanged",m);this.bind("Error",u);this.bind("FileUploaded",v);this.bind("Destroy",t)}function C(R,O){var P=this,N=0,M=[];var Q={runtime_order:R.runtimes,required_caps:R.required_features,preferred_caps:A,swf_url:R.flash_swf_url,xap_url:R.silverlight_xap_url};h.each(R.runtimes.split(/\s*,\s*/),function(S){if(R[S]){Q[S]=R[S]}});if(R.browse_button){h.each(R.browse_button,function(S){M.push(function(T){var U=new c.file.FileInput(h.extend({},Q,{accept:R.filters.mime_types,name:R.file_data_name,multiple:R.multi_selection,container:R.container,browse_button:S}));U.onready=function(){var V=b.getInfo(this.ruid);h.extend(P.features,{chunks:V.can("slice_blob"),multipart:V.can("send_multipart"),multi_selection:V.can("select_multiple")});N++;H.push(this);T()};U.onchange=function(){P.addFile(this.files)};U.bind("mouseenter mouseleave mousedown mouseup",function(V){if(!q){if(R.browse_button_hover){if("mouseenter"===V.type){h.addClass(S,R.browse_button_hover)}else{if("mouseleave"===V.type){h.removeClass(S,R.browse_button_hover)}}}if(R.browse_button_active){if("mousedown"===V.type){h.addClass(S,R.browse_button_active)}else{if("mouseup"===V.type){h.removeClass(S,R.browse_button_active)}}}}});U.bind("mousedown",function(){P.trigger("Browse")});U.bind("error runtimeerror",function(){U=null;T()});U.init()})})}if(R.drop_element){h.each(R.drop_element,function(S){M.push(function(T){var U=new c.file.FileDrop(h.extend({},Q,{drop_zone:S}));U.onready=function(){var V=b.getInfo(this.ruid);h.extend(P.features,{chunks:V.can("slice_blob"),multipart:V.can("send_multipart"),dragdrop:V.can("drag_and_drop")});N++;z.push(this);T()};U.ondrop=function(){P.addFile(this.files)};U.bind("error runtimeerror",function(){U=null;T()});U.init()})})}h.inSeries(M,function(){if(typeof(O)==="function"){O(N)}})}function r(O,R,Q,M){var N=new c.image.Image();try{N.onload=function(){if(R.width>this.width&&R.height>this.height&&R.quality===e&&R.preserve_headers&&!R.crop){this.destroy();M(O)}else{N.downsize(R.width,R.height,R.crop,R.preserve_headers)}};N.onresize=function(){var S=this.getAsBlob(O.type,R.quality);this.destroy();M(S)};N.bind("error runtimeerror",function(){this.destroy();M(O)});N.load(O,Q)}catch(P){M(O)}}function p(O,Q,R){var N=this,M=false;function P(T,U,V){var S=I[T];switch(T){case"max_file_size":if(T==="max_file_size"){I.max_file_size=I.filters.max_file_size=U}break;case"chunk_size":if(U=h.parseSize(U)){I[T]=U;I.send_file_name=true}break;case"multipart":I[T]=U;if(!U){I.send_file_name=true}break;case"http_method":I[T]=U.toUpperCase()==="PUT"?"PUT":"POST";break;case"unique_names":I[T]=U;if(U){I.send_file_name=true}break;case"filters":if(h.typeOf(U)==="array"){U={mime_types:U}}if(V){h.extend(I.filters,U)}else{I.filters=U}if(U.mime_types){if(h.typeOf(U.mime_types)==="string"){U.mime_types=c.core.utils.Mime.mimes2extList(U.mime_types)}U.mime_types.regexp=(function(W){var X=[];h.each(W,function(Y){h.each(Y.extensions.split(/,/),function(Z){if(/^\s*\*\s*$/.test(Z)){X.push("\\.*")}else{X.push("\\."+Z.replace(new RegExp("["+("/^$.*+?|()[]{}\\".replace(/./g,"\\$&"))+"]","g"),"\\$&"))}})});return new RegExp("("+X.join("|")+")$","i")}(U.mime_types));I.filters.mime_types=U.mime_types}break;case"resize":if(U){I.resize=h.extend({preserve_headers:true,crop:false},U)}else{I.resize=false}break;case"prevent_duplicates":I.prevent_duplicates=I.filters.prevent_duplicates=!!U;break;case"container":case"browse_button":case"drop_element":U="container"===T?h.get(U):h.getAll(U);case"runtimes":case"multi_selection":case"flash_swf_url":case"silverlight_xap_url":I[T]=U;if(!V){M=true}break;default:I[T]=U}if(!V){N.trigger("OptionChanged",T,U,S)}}if(typeof(O)==="object"){h.each(O,function(T,S){P(S,T,R)})}else{P(O,Q,R)}if(R){I.required_features=i(h.extend({},I));A=i(h.extend({},I,{required_features:true}))}else{if(M){N.trigger("Destroy");C.call(N,I,function(S){if(S){N.runtime=b.getInfo(J()).type;N.trigger("Init",{runtime:N.runtime});N.trigger("PostInit")}else{N.trigger("Error",{code:h.INIT_ERROR,message:h.translate("Init error.")})}})}}}function E(M,N){if(M.settings.unique_names){var P=N.name.match(/\.([^.]+)$/),O="part";if(P){O=P[1]}N.target_name=N.id+"."+O}}function G(V,S){var P=V.settings.url;var T=V.settings.chunk_size;var W=V.settings.max_retries;var Q=V.features;var U=0;var N;var X={runtime_order:V.settings.runtimes,required_caps:V.settings.required_features,preferred_caps:A,swf_url:V.settings.flash_swf_url,xap_url:V.settings.silverlight_xap_url};if(S.loaded){U=S.loaded=T?T*Math.floor(S.loaded/T):0}function R(){if(W-->0){g(O,1000)}else{S.loaded=U;V.trigger("Error",{code:h.HTTP_ERROR,message:h.translate("HTTP Error."),file:S,response:y.responseText,status:y.status,responseHeaders:y.getAllResponseHeaders()})}}function O(){var Z,Y={},aa;if(S.status!==h.UPLOADING||V.state===h.STOPPED){return}if(V.settings.send_file_name){Y.name=S.target_name||S.name}if(T&&Q.chunks&&N.size>T){aa=Math.min(T,N.size-U);Z=N.slice(U,U+aa)}else{aa=N.size;Z=N}if(T&&Q.chunks){if(V.settings.send_chunk_number){Y.chunk=Math.ceil(U/T);Y.chunks=Math.ceil(N.size/T)}else{Y.offset=U;Y.total=N.size}}if(V.trigger("BeforeChunkUpload",S,Y,Z,U)){M(Y,Z,aa)}}function M(Y,aa,ab){var Z;y=new c.xhr.XMLHttpRequest();if(y.upload){y.upload.onprogress=function(ac){S.loaded=Math.min(S.size,U+ac.loaded);V.trigger("UploadProgress",S)}}y.onload=function(){if(y.status<200||y.status>=400){R();return}W=V.settings.max_retries;if(ab<N.size){aa.destroy();U+=ab;S.loaded=Math.min(U,N.size);V.trigger("ChunkUploaded",S,{offset:S.loaded,total:N.size,response:y.responseText,status:y.status,responseHeaders:y.getAllResponseHeaders()});if(h.ua.browser==="Android Browser"){V.trigger("UploadProgress",S)}}else{S.loaded=S.size}aa=Z=null;if(!U||U>=N.size){if(S.size!=S.origSize){N.destroy();N=null}V.trigger("UploadProgress",S);S.status=h.DONE;S.completeTimestamp=+new Date();V.trigger("FileUploaded",S,{response:y.responseText,status:y.status,responseHeaders:y.getAllResponseHeaders()})}else{g(O,1)}};y.onerror=function(){R()};y.onloadend=function(){this.destroy()};if(V.settings.multipart&&Q.multipart){y.open(V.settings.http_method,P,true);h.each(V.settings.headers,function(ad,ac){y.setRequestHeader(ac,ad)});Z=new c.xhr.FormData();h.each(h.extend(Y,V.settings.multipart_params),function(ad,ac){Z.append(ac,ad)});Z.append(V.settings.file_data_name,aa);y.send(Z,X)}else{P=h.buildUrl(V.settings.url,h.extend(Y,V.settings.multipart_params));y.open(V.settings.http_method,P,true);h.each(V.settings.headers,function(ad,ac){y.setRequestHeader(ac,ad)});if(!y.hasRequestHeader("Content-Type")){y.setRequestHeader("Content-Type","application/octet-stream")}y.send(aa,X)}}N=S.getSource();if(!h.isEmptyObj(V.settings.resize)&&h.inArray(N.type,["image/jpeg","image/png"])!==-1){r(N,V.settings.resize,X,function(Y){N=Y;S.size=Y.size;O()})}else{O()}}function x(M,N){n(N)}function D(M){if(M.state==h.STARTED){F=(+new Date())}else{if(M.state==h.STOPPED){for(var N=M.files.length-1;N>=0;N--){if(M.files[N].status==h.UPLOADING){M.files[N].status=h.QUEUED;m()}}}}}function l(){if(y){y.abort()}}function v(M){m();g(function(){K.call(M)},1)}function u(M,N){if(N.code===h.INIT_ERROR){M.destroy()}else{if(N.code===h.HTTP_ERROR){N.file.status=h.FAILED;N.file.completeTimestamp=+new Date();n(N.file);if(M.state==h.STARTED){M.trigger("CancelUpload");g(function(){K.call(M)},1)}}}}function t(M){M.stop();h.each(s,function(N){N.destroy()});s=[];if(H.length){h.each(H,function(N){N.destroy()});H=[]}if(z.length){h.each(z,function(N){N.destroy()});z=[]}A={};q=false;F=y=null;L.reset()}I={chunk_size:0,file_data_name:"file",filters:{mime_types:[],max_file_size:0,prevent_duplicates:false,prevent_empty:true},flash_swf_url:"js/Moxie.swf",http_method:"POST",max_retries:0,multipart:true,multi_selection:true,resize:false,runtimes:b.order,send_file_name:true,send_chunk_number:true,silverlight_xap_url:"js/Moxie.xap"};p.call(this,o,null,true);L=new h.QueueProgress();h.extend(this,{id:w,uid:w,state:h.STOPPED,features:{},runtime:null,files:s,settings:I,total:L,init:function(){var M=this,N,P,O;P=M.getOption("preinit");if(typeof(P)=="function"){P(M)}else{h.each(P,function(R,Q){M.bind(Q,R)})}B.call(M);h.each(["container","browse_button","drop_element"],function(Q){if(M.getOption(Q)===null){O={code:h.INIT_ERROR,message:h.sprintf(h.translate("%s specified, but cannot be found."),Q)};return false}});if(O){return M.trigger("Error",O)}if(!I.browse_button&&!I.drop_element){return M.trigger("Error",{code:h.INIT_ERROR,message:h.translate("You must specify either browse_button or drop_element.")})}C.call(M,I,function(Q){var R=M.getOption("init");if(typeof(R)=="function"){R(M)}else{h.each(R,function(T,S){M.bind(S,T)})}if(Q){M.runtime=b.getInfo(J()).type;M.trigger("Init",{runtime:M.runtime});M.trigger("PostInit")}else{M.trigger("Error",{code:h.INIT_ERROR,message:h.translate("Init error.")})}})},setOption:function(M,N){p.call(this,M,N,!this.runtime)},getOption:function(M){if(!M){return I}return I[M]},refresh:function(){if(H.length){h.each(H,function(M){M.trigger("Refresh")})}this.trigger("Refresh")},start:function(){if(this.state!=h.STARTED){this.state=h.STARTED;this.trigger("StateChanged");K.call(this)}},stop:function(){if(this.state!=h.STOPPED){this.state=h.STOPPED;this.trigger("StateChanged");this.trigger("CancelUpload")}},disableBrowse:function(){q=arguments[0]!==e?arguments[0]:true;if(H.length){h.each(H,function(M){M.disable(q)})}this.trigger("DisableBrowse",q)},getFile:function(N){var M;for(M=s.length-1;M>=0;M--){if(s[M].id===N){return s[M]}}},addFile:function(R,T){var O=this,M=[],N=[],P;function S(W,V){var U=[];h.each(O.settings.filters,function(Y,X){if(j[X]){U.push(function(Z){j[X].call(O,Y,W,function(aa){Z(!aa)})})}});h.inSeries(U,V)}function Q(U){var V=h.typeOf(U);if(U instanceof c.file.File){if(!U.ruid&&!U.isDetached()){if(!P){return false}U.ruid=P;U.connectRuntime(P)}Q(new h.File(U))}else{if(U instanceof c.file.Blob){Q(U.getSource());U.destroy()}else{if(U instanceof h.File){if(T){U.name=T}M.push(function(W){S(U,function(X){if(!X){s.push(U);N.push(U);O.trigger("FileFiltered",U)}g(W,1)})})}else{if(h.inArray(V,["file","blob"])!==-1){Q(new c.file.File(null,U))}else{if(V==="node"&&h.typeOf(U.files)==="filelist"){h.each(U.files,Q)}else{if(V==="array"){T=null;h.each(U,Q)}}}}}}}P=J();Q(R);if(M.length){h.inSeries(M,function(){if(N.length){O.trigger("FilesAdded",N)}})}},removeFile:function(N){var O=typeof(N)==="string"?N:N.id;for(var M=s.length-1;M>=0;M--){if(s[M].id===O){return this.splice(M,1)[0]}}},splice:function(P,M){var N=s.splice(P===e?0:P,M===e?s.length:M);var O=false;if(this.state==h.STARTED){h.each(N,function(Q){if(Q.status===h.UPLOADING){O=true;return false}});if(O){this.stop()}}this.trigger("FilesRemoved",N);h.each(N,function(Q){Q.destroy()});if(O){this.start()}return N},dispatchEvent:function(P){var Q,N,M;P=P.toLowerCase();Q=this.hasEventListener(P);if(Q){Q.sort(function(S,R){return R.priority-S.priority});N=[].slice.call(arguments);N.shift();N.unshift(this);for(var O=0;O<Q.length;O++){if(Q[O].fn.apply(Q[O].scope,N)===false){return false}}}return true},bind:function(M,P,O,N){h.Uploader.prototype.bind.call(this,M,P,N,O)},destroy:function(){this.trigger("Destroy");I=L=null;this.unbindAll()}})};h.Uploader.prototype=c.core.EventTarget.instance;h.File=(function(){var m={};function l(n){h.extend(this,{id:h.guid(),name:n.name||n.fileName,type:n.type||"",relativePath:n.relativePath||"",size:n.fileSize||n.size,origSize:n.fileSize||n.size,loaded:0,percent:0,status:h.QUEUED,lastModifiedDate:n.lastModifiedDate||(new Date()).toLocaleString(),completeTimestamp:0,getNative:function(){var o=this.getSource().getSource();return h.inArray(h.typeOf(o),["blob","file"])!==-1?o:null},getSource:function(){if(!m[this.id]){return null}return m[this.id]},destroy:function(){var o=this.getSource();if(o){o.destroy();delete m[this.id]}}});m[this.id]=n}return l}());h.QueueProgress=function(){var l=this;l.size=0;l.loaded=0;l.uploaded=0;l.failed=0;l.queued=0;l.percent=0;l.bytesPerSec=0;l.reset=function(){l.size=l.loaded=l.uploaded=l.failed=l.queued=l.percent=l.bytesPerSec=0}};f.plupload=h}(this,a))}));